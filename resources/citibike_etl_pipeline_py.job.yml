resources:
  jobs:
    citibike_etl_pipeline_py:
      name: citibike_etl_pipeline_py
      tasks:
        - task_key: 01_bronze_citibike
          spark_python_task:
            python_file: ../citibike_etl/scripts/01_bronze/01_bronze_citibike.py
            parameters:
              - "{{job.id}}"
              - "{{job.run_id}}"
              - "{{task.run_id}}"
              - "{{job.start_time.iso_datetime}}"
              - "${var.catalog}"
          #job_cluster_key: ds3_v2_sn
          environment_key: citibike_task_environment
        - task_key: 02_silver_citibike
          depends_on:
            - task_key: 01_bronze_citibike
          spark_python_task:
            python_file: ../citibike_etl/scripts/02_silver/02_silver_citibike.py
            parameters:
              - "{{job.id}}"
              - "{{job.run_id}}"
              - "{{task.run_id}}"
              - "{{job.start_time.iso_datetime}}"
              - "${var.catalog}"
          #job_cluster_key: ds3_v2_sn
          environment_key: citibike_task_environment
          #libraries:
            #- whl: ../dist/*.whl
        - task_key: 03_gold_citibike_daily_ride_summary
          depends_on:
            - task_key: 02_silver_citibike
          spark_python_task:
            python_file: ../citibike_etl/scripts/03_gold/03_gold_citibike_daily_ride_summary.py
            parameters:
              - "${var.catalog}"
          #job_cluster_key: ds3_v2_sn
          environment_key: citibike_task_environment
        - task_key: 03_gold_citibike_daily_station_performance
          depends_on:
            - task_key: 02_silver_citibike
          spark_python_task:
            python_file: ../citibike_etl/scripts/03_gold/03_gold_citibike_daily_station_performance.py
            parameters:
              - "${var.catalog}"
      #    #job_cluster_key: ds3_v2_sn
      #job_clusters:
      #  - #job_cluster_key: ds3_v2_sn
      #    new_cluster: "${var.ds3_v2_sn}"
      #environments is beacause we are using serveless clusters
          environment_key: citibike_task_environment
      queue:
        enabled: true
      environments:
        - environment_key: Default
          spec:
            environment_version: "4"
        - environment_key: citibike_task_environment
          spec:
            dependencies:
              - ../dist/*.whl #to include the latest built wheel file in the dist folder
            environment_version: "4"
      performance_target: PERFORMANCE_OPTIMIZED




#to run it with job clusters #uncomment the job_clusters section and the job_cluster_key lines in each task
#to run it with serverless clusters using environments #uncomment the environments section and the environment_key lines in each task

#in order to use python wheel, we remove the libraries section in each task and add the dependencies section under the citibike_task_environment environment
#but to use python wheel without environments ass task as the first part of the jobs 
#we create a task first to install the python wheels and the since its pre installed it will be used in the rest of the pipeline*
#so we create a task called 00_wheel upload